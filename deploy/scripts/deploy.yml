---
- name: Fetch AWS secrets
  hosts: localhost
  gather_facts: no
  vars:
    env_name: "{{ lookup('env', 'ENV_NAME') | default('prod', true) }}"
    key_prefix: "{{ env_name }}/mycrocloud"
    env_files:
      - "api/.env"
      - "dbmigrator/.env"
      - "web/.env"
      - "webapp/gateway/.env"
      - "webapp/spa/worker/.env"
      - "monitoring/seq/.env"
    secret_files:
      - "lb/certs/mycrocloud.info.key"
      - "api/gha-mycrocloud.private-key.pem"
    template_secrets:
      - "monitoring/prometheus.yml"
  tasks:
    - name: Fetch env files from AWS Secrets Manager
      vars:
        secret_key: "{{ key_prefix }}/{{ item }}"
        secret_value: "{{ lookup('amazon.aws.aws_secret', secret_key) }}"
      set_fact:
        env_secrets: "{{ env_secrets | default({}) | combine({item: secret_value}) }}"
      loop: "{{ env_files }}"
      no_log: true

    - name: Fetch secret files from AWS Secrets Manager
      vars:
        secret_key: "{{ key_prefix }}/{{ item }}"
        secret_value: "{{ lookup('amazon.aws.aws_secret', secret_key) }}"
      set_fact:
        file_secrets: "{{ file_secrets | default({}) | combine({item: secret_value}) }}"
      loop: "{{ secret_files }}"
      no_log: true

    - name: Fetch template secrets from AWS Secrets Manager
      vars:
        secret_key: "{{ key_prefix }}/{{ item }}"
        secret_value: "{{ lookup('amazon.aws.aws_secret', secret_key) }}"
      set_fact:
        template_secrets_data: "{{ template_secrets_data | default({}) | combine({item: secret_value}) }}"
      loop: "{{ template_secrets }}"
      no_log: true

- name: Deploy
  hosts: all
  become: no
  vars:
    src: ../pkg
    deploy_path: /opt/mycrocloud
    service_group: ""
    services: []
    service_groups:
      core:
        - lb
        - api
        - web
        - db-migrator
      webapp:
        - gateway
        - spa-worker
      monitoring:
        - seq
        - prometheus
        - node_exporter
        - nginx-exporter
    resolved_services: "{{ service_groups[service_group] | default([]) if (service_group | length > 0 and services | length == 0) else services }}"
  tasks:
    - name: Ensure deploy directory exists
      ansible.builtin.file:
        path: "{{ deploy_path }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: yes

    - name: Sync application files to server
      ansible.builtin.synchronize:
        src: "{{ src }}/"
        dest: "{{ deploy_path }}"
        recursive: yes
        delete: yes

    - name: Write env files
      ansible.builtin.copy:
        content: "{{ hostvars['localhost']['env_secrets'][item] }}"
        dest: "{{ deploy_path }}/{{ item }}"
        mode: "0600"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ hostvars['localhost']['env_files'] }}"
      no_log: true

    - name: Write secret files
      ansible.builtin.copy:
        content: "{{ hostvars['localhost']['file_secrets'][item] }}"
        dest: "{{ deploy_path }}/{{ item }}"
        mode: "0600"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ hostvars['localhost']['secret_files'] }}"
      no_log: true

    - name: Generate templated files
      ansible.builtin.template:
        src: "{{ src }}/{{ item }}.j2"
        dest: "{{ deploy_path }}/{{ item }}"
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      vars:
        secret: "{{ hostvars['localhost']['template_secrets_data'][item] }}"
      loop: "{{ template_secrets }}"
      no_log: true

    - name: Pull and deploy services
      community.docker.docker_compose_v2:
        project_src: "{{ deploy_path }}"
        services: "{{ resolved_services if resolved_services | length > 0 else omit }}"
        state: present
        pull: always
      register: deploy_result

    - name: Wait for services to be healthy
      ansible.builtin.shell:
        cmd: |
          services_list="{{ resolved_services | join(' ') }}"
          for service in $(docker compose ps --format '{{.Service}}'); do
            if [ -z "$services_list" ] || echo "$services_list" | grep -q "$service"; then
              status=$(docker compose ps $service --format '{{.Health}}')
              if [ "$status" != "healthy" ] && [ "$status" != "" ]; then
                echo "Service $service is $status"
                exit 1
              fi
            fi
          done
        chdir: "{{ deploy_path }}"
      register: health_check
      retries: 5
      delay: 5
      until: health_check.rc == 0
      when: resolved_services | length >= 0

    - name: Reload nginx if dependencies require it
      ansible.builtin.command:
        cmd: docker compose exec lb nginx -s reload
        chdir: "{{ deploy_path }}"
      when:
        - (resolved_services | length == 0 or resolved_services | intersect(['api', 'gateway', 'web']) | length > 0)
        - deploy_result.changed | default(false)
