---
- name: Fetch AWS secrets
  hosts: localhost
  gather_facts: no
  vars:
    pull_only: false
    secret_name_prefix: "prod/mycrocloud"
    # Configuration files that are generated from Jinja2 templates (.j2)
    # The secret name on AWS should match the path without the .j2 extension
    j2_template_files:
      - "api/.env.j2"
      - "dbmigrator/.env.j2"
      - "webapp/gateway/.env.j2"
      - "webapp/spa/worker/.env.j2"
      - "monitoring/seq/.env.j2"
      - "monitoring/prometheus/prometheus.yml.j2"
    # Secret files (like certificates or keys) that are written directly to the server as plaintext
    plaintext_secret_files:
      - "lb/certs/mycrocloud.info.key"
      - "api/gha-mycrocloud.private-key.pem"
  tasks:
    - name: Register file lists as host facts
      when: not (pull_only | bool)
      set_fact:
        j2_template_files: "{{ j2_template_files }}"
        plaintext_secret_files: "{{ plaintext_secret_files }}"

    - name: Fetch env files from AWS Secrets Manager
      when: not (pull_only | bool)
      vars:
        secret_key: "{{ secret_name_prefix }}/{{ item | regex_replace('\\.j2$', '') }}"
        secret_value: "{{ lookup('amazon.aws.aws_secret', secret_key) }}"
      set_fact:
        j2_template_secrets: "{{ j2_template_secrets | default({}) | combine({item: secret_value}) }}"
      loop: "{{ j2_template_files }}"
      loop_control:
        label: "{{ item }}"
      no_log: true

    - name: Fetch secret files from AWS Secrets Manager
      when: not (pull_only | bool)
      vars:
        secret_key: "{{ secret_name_prefix }}/{{ item }}"
        secret_value: "{{ lookup('amazon.aws.aws_secret', secret_key) }}"
      set_fact:
        plaintext_secret_values: "{{ plaintext_secret_values | default({}) | combine({item: secret_value}) }}"
      loop: "{{ plaintext_secret_files }}"
      loop_control:
        label: "{{ item }}"
      no_log: true

- name: Deploy
  hosts: all
  become: no
  vars:
    src: ../pkg
    deploy_path: /opt/mycrocloud
    pull_only: false
    image: ""
    service_group: ""
    services: []
    service_groups:
      core:
        - lb
        - api
        - web
        - db-migrator
      webapp:
        - gateway
        - spa-worker
      monitoring:
        - seq
        - prometheus
        - node_exporter
        - nginx-exporter
    resolved_services: "{{ service_groups[service_group] | default([]) if (service_group | length > 0 and services | length == 0) else services }}"
  tasks:
    - name: Pull Docker image
      ansible.builtin.command:
        cmd: docker pull {{ image }}
      when: image | length > 0

    - name: Ensure deploy directory exists
      when: not (pull_only | bool)
      ansible.builtin.file:
        path: "{{ deploy_path }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: yes

    - name: Sync application files to server
      when: not (pull_only | bool)
      ansible.builtin.synchronize:
        src: "{{ src }}/"
        dest: "{{ deploy_path }}"
        recursive: yes
        delete: yes

    - name: Copy web env file
      when: not (pull_only | bool)
      ansible.builtin.copy:
        src: "{{ deploy_path }}/web/dotenv"
        dest: "{{ deploy_path }}/web/.env"
        remote_src: yes
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    # Renders J2 templates using secrets from AWS
    - name: Render J2 template files
      when: not (pull_only | bool)
      ansible.builtin.template:
        src: "{{ src }}/{{ item }}"
        dest: "{{ deploy_path }}/{{ item | regex_replace('\\.j2$', '') }}"
        mode: "0600"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ hostvars['localhost']['j2_template_files'] }}"
      vars:
        secrets: "{{ hostvars['localhost']['j2_template_secrets'][item] | from_json }}"
      no_log: true

    # Writes raw secret files (certs, keys) directly to the server
    - name: Write plaintext secret files
      when: not (pull_only | bool)
      ansible.builtin.copy:
        content: "{{ hostvars['localhost']['plaintext_secret_values'][item] }}"
        dest: "{{ deploy_path }}/{{ item }}"
        mode: "0600"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ hostvars['localhost']['plaintext_secret_files'] }}"
      no_log: true

    - name: Pull and deploy services
      when: not (pull_only | bool)
      community.docker.docker_compose_v2:
        project_src: "{{ deploy_path }}"
        services: "{{ resolved_services if resolved_services | length > 0 else omit }}"
        state: present
        pull: always
      register: deploy_result

    - name: Wait for services to be healthy
      when: not (pull_only | bool)
      ansible.builtin.shell:
        cmd: |
          services_list="{{ resolved_services | join(' ') }}"
          for service in $(docker compose ps --format '{{.Service}}'); do
            if [ -z "$services_list" ] || echo "$services_list" | grep -q "$service"; then
              status=$(docker compose ps $service --format '{{.Health}}')
              if [ "$status" != "healthy" ] && [ "$status" != "" ]; then
                echo "Service $service is $status"
                exit 1
              fi
            fi
          done
        chdir: "{{ deploy_path }}"
      register: health_check
      retries: 5
      delay: 5
      until: health_check.rc == 0

    - name: Reload nginx if dependencies require it
      ansible.builtin.command:
        cmd: docker compose exec lb nginx -s reload
        chdir: "{{ deploy_path }}"
      when:
        - not (pull_only | bool)
        - (resolved_services | length == 0 or resolved_services | intersect(['api', 'gateway', 'web']) | length > 0)
        - deploy_result.changed | default(false)
