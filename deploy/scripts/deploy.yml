---
- name: Fetch AWS secrets
  hosts: localhost
  gather_facts: no
  vars:
    key_prefix: "prod/mycrocloud"
    env_files:
      - "api/.env"
      - "dbmigrator/.env"
      - "web/.env"
      - "webapp/gateway/.env"
      - "webapp/spa/worker/.env"
    secret_files:
      - "lb/certs/mycrocloud.info.key"
      - "api/gha-mycrocloud.pem"
    template_secrets:
      - "monitoring/prometheus.yml"
  tasks:
    - name: Fetch env files from AWS Secrets Manager
      vars:
        secret_key: "{{ key_prefix }}/{{ item }}"
        secret_value: "{{ lookup('amazon.aws.aws_secret', secret_key) }}"
      set_fact:
        env_secrets: "{{ env_secrets | default({}) | combine({item: secret_value}) }}"
      loop: "{{ env_files }}"
      no_log: true

    - name: Fetch secret files from AWS Secrets Manager
      vars:
        secret_key: "{{ key_prefix }}/{{ item }}"
        secret_value: "{{ lookup('amazon.aws.aws_secret', secret_key) }}"
      set_fact:
        file_secrets: "{{ file_secrets | default({}) | combine({item: secret_value}) }}"
      loop: "{{ secret_files }}"
      no_log: true

    - name: Fetch template secrets from AWS Secrets Manager
      vars:
        secret_key: "{{ key_prefix }}/{{ item }}"
        secret_value: "{{ lookup('amazon.aws.aws_secret', secret_key) }}"
      set_fact:
        template_secrets_data: "{{ template_secrets_data | default({}) | combine({item: secret_value}) }}"
      loop: "{{ template_secrets }}"
      no_log: true

- name: Deploy
  hosts: all
  become: no
  vars:
    src: ../pkg
    deploy_path: /opt/mycrocloud
    namespace: default
    service: all
    namespaces:
      default:
        path: "{{ deploy_path }}"
      webapp:
        path: "{{ deploy_path }}/webapp"
      monitoring:
        path: "{{ deploy_path }}/monitoring"
  tasks:
    - name: Ensure deploy directory exists
      ansible.builtin.file:
        path: "{{ deploy_path }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: yes

    - name: Sync application files to server
      ansible.builtin.synchronize:
        src: "{{ src }}/"
        dest: "{{ deploy_path }}"
        recursive: yes
        delete: yes

    - name: Write env files
      ansible.builtin.copy:
        content: "{{ hostvars['localhost']['env_secrets'][item] }}"
        dest: "{{ deploy_path }}/{{ item }}"
        mode: "0600"
      loop: "{{ hostvars['localhost']['env_files'] }}"
      no_log: true

    - name: Write secret files
      ansible.builtin.copy:
        content: "{{ hostvars['localhost']['file_secrets'][item] }}"
        dest: "{{ deploy_path }}/{{ item }}"
        mode: "0600"
      loop: "{{ hostvars['localhost']['secret_files'] }}"
      no_log: true

    - name: Generate templated files
      ansible.builtin.template:
        src: "{{ src }}/{{ item }}.j2"
        dest: "{{ deploy_path }}/{{ item }}"
        mode: "0644"
      vars:
        secret: "{{ hostvars['localhost']['template_secrets_data'][item] }}"
      loop: "{{ template_secrets }}"
      no_log: true

    - name: Pull and deploy services
      community.docker.docker_compose_v2:
        project_src: "{{ namespaces[namespace].path }}"
        services: "{{ omit if service == 'all' else [service] }}"
        state: present
        pull: always

    - name: Reload nginx if dependencies require it
      ansible.builtin.command:
        cmd: docker compose exec lb nginx -s reload
        chdir: "{{ deploy_path }}"
      when: service in ['api', 'gateway', 'web', 'web-editor']
