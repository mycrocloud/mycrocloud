---
- name: Get AWS secrets locally
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - amazon.aws
  
  vars:
    aws_region: ap-northeast-1
  tasks:
    - name: Fetch secret from AWS Secrets Manager
      set_fact:
        secrets: "{{ lookup('amazon.aws.aws_secret', 'prod/mycrocloud/.env', region=aws_region) | from_json }}"
      no_log: true

- name: Deploy application to server
  hosts: mycrocloud
  become: yes

  vars:
    deploy_path: /opt/mycrocloud

  tasks:
    - name: Test SSH connection
      ping:

    - name: Ensure deploy directory exists
      ansible.builtin.file:
        path: "{{ deploy_path }}"
        state: directory
        mode: "0755"

    - name: Sync application files to server
      ansible.builtin.synchronize:
        src: "../app/"
        dest: "{{ deploy_path }}"
        recursive: yes
        delete: yes
      tags: sync

    - name: Generate .env file from template
      ansible.builtin.template:
        src: "../app/.env.j2"
        dest: "{{ deploy_path }}/.env"
        mode: "0600"
        owner: ubuntu
        group: ubuntu
      vars:
        secrets: "{{ hostvars['localhost']['secrets'] }}"
      no_log: true
      tags: secrets
