---
- name: Fetch AWS secrets
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - amazon.aws

  vars:
    aws_region: ap-northeast-1
  tasks:
    - name: Fetch secret from AWS Secrets Manager
      set_fact:
        secrets: "{{ lookup('amazon.aws.aws_secret', 'prod/mycrocloud/.env', region=aws_region) | from_json }}"
      no_log: true

    - name: Fetch lb/certs/mycrocloud.info.key
      set_fact:
        lb_certs_mycrocloud_info_key: "{{ lookup('amazon.aws.aws_secret', 'prod/mycrocloud/lb/certs/mycrocloud.info.key', region=aws_region) }}"
      no_log: true

    - name: Fetch Services/WebApp/deployment/.env
      set_fact:
        Services_WebApp_deployment_dotenv: "{{ lookup('amazon.aws.aws_secret', 'prod/mycrocloud/Services/WebApp/deployment/.env', region=aws_region) | from_json }}"
      no_log: true

    - name: Fetch Services/WebApp/WebApp.Api/gha-mycrocloud.pem
      set_fact:
        Services_WebApp_WebApp_Api_gha_mycrocloud_pem: "{{ lookup('amazon.aws.aws_secret', 'prod/mycrocloud/Services/WebApp/WebApp.Api/gha-mycrocloud.pem', region=aws_region) }}"
      no_log: true

- name: Sync files to server
  hosts: mycrocloud
  become: yes

  vars:
    src: ../app
    deploy_path: /opt/mycrocloud

  tasks:
    - name: Ensure deploy directory exists
      ansible.builtin.file:
        path: "{{ deploy_path }}"
        state: directory
        mode: "0755"

    - name: Sync application files to server
      ansible.builtin.synchronize:
        src: "{{ src }}/"
        dest: "{{ deploy_path }}"
        recursive: yes
        delete: yes
      tags: sync

    - name: Generate .env file from template
      ansible.builtin.template:
        src: "{{ src }}/.env.j2"
        dest: "{{ deploy_path }}/.env"
        mode: "0600"
        owner: ubuntu
        group: ubuntu
      vars:
        secrets: "{{ hostvars['localhost']['secrets'] }}"
      no_log: true
      tags: secrets

    - name: Write certificate key file
      ansible.builtin.copy:
        content: "{{ hostvars['localhost']['lb_certs_mycrocloud_info_key'] }}"
        dest: "{{ deploy_path }}/lb/certs/mycrocloud.info.key"
        mode: "0600"
        owner: ubuntu
        group: ubuntu
      no_log: true
      tags:
        - secrets
        - certs

    - name: Generate Services/WebApp/deployment/.env file from template
      ansible.builtin.template:
        src: "{{ src }}/Services/WebApp/deployment/.env.j2"
        dest: "{{ deploy_path }}/Services/WebApp/deployment/.env"
        mode: "0600"
        owner: ubuntu
        group: ubuntu
      vars:
        secrets: "{{ hostvars['localhost']['Services_WebApp_deployment_dotenv'] }}"
      no_log: true
      tags: Services_WebApp_deployment_dotenv

    - name: Write Services/WebApp/WebApp.Api/gha-mycrocloud.pem file
      ansible.builtin.copy:
        content: "{{ hostvars['localhost']['Services_WebApp_WebApp_Api_gha_mycrocloud_pem'] }}"
        dest: "{{ deploy_path }}/Services/WebApp/WebApp.Api/gha-mycrocloud.pem"
        mode: "0600"
        owner: ubuntu
        group: ubuntu
      no_log: true

    - name: Rename Web/.env.example to Web/.env
      ansible.builtin.copy:
        src: "{{ deploy_path }}/Web/.env.example"
        dest: "{{ deploy_path }}/Web/.env"
        remote_src: true