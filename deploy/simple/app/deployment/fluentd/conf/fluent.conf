<source>
  @type unix
  path /var/run/fluentd/fluentd.sock
</source>

<filter app.builder app.worker>
  @type record_transformer
  enable_ruby true
  <record>
    tag ${tag}
    @timestamp ${time.strftime('%Y-%m-%dT%H:%M:%S%z')}
  </record>
</filter>

<match app.builder app.worker>
  @type copy

  <store>
    @type elasticsearch
    host "#{ENV['ES_HOST']}"
    index_name build-logs
    <buffer>
      flush_interval 5s
    </buffer>
  </store>
  
  <store>
    @type rabbitmq
    amqp_url "#{ENV['RABBITMQ_URL']}"
    exchange app.build.logs
    exchange_type topic
    routing_key app_build_logs.${record["build_id"]}
  </store>

  <store>
    @type stdout
  </store>
</match>