<source>
  @type unix
  path /var/run/fluentd/fluentd.sock
</source>

<filter app.builder.**>
  @type record_transformer
  enable_ruby true
  <record>
    @timestamp ${time.iso8601(9)}
    level ${record["level"] || "info"}
    message ${record["log"] || ""}
    source ${tag_parts[1]}
    job_id ${tag_parts[2]}
  </record>
  remove_keys log
</filter>

<match app.builder.**>
  @type copy

  <store>
    @type elasticsearch
    host "#{ENV['ES_HOST']}"
    scheme https
    port 443
    user "#{ENV['ES_USER']}"
    password "#{ENV['ES_PASSWORD']}"
    index_name build-logs
    <buffer>
      flush_interval 5s
    </buffer>
  </store>

  <store>
    @type stdout
  </store>
</match>