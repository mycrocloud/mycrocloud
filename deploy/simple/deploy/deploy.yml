---
- name: Fetch AWS secrets
  hosts: localhost
  gather_facts: no
  vars:
    aws_secrets:
      secrets:
        key: "prod/mycrocloud/.env"
        json: true
      lb_certs_mycrocloud_info_key:
        key: "prod/mycrocloud/lb/certs/mycrocloud.info.key"
        json: false
      Services_WebApp_deployment_dotenv:
        key: "prod/mycrocloud/Services/WebApp/deployment/.env"
        json: true
      Services_WebApp_WebApp_Api_gha_mycrocloud_pem:
        key: "prod/mycrocloud/Services/WebApp/WebApp.Api/gha-mycrocloud.pem"
        json: false
  tasks:
    - name: Fetch all secrets from AWS Secrets Manager
      set_fact:
        "{{ item.key }}": "{{ lookup('amazon.aws.aws_secret', item.value.key, region=aws_region if aws_region else omit, profile=aws_profile if aws_profile else omit) | from_json if item.value.json else lookup('amazon.aws.aws_secret', item.value.key, region=aws_region if aws_region else omit, profile=aws_profile if aws_profile else omit) }}"
      loop: "{{ aws_secrets | dict2items }}"
      no_log: true

- name: Deploy
  hosts: all
  become: no
  vars:
    src: app
    deploy_path: /opt/mycrocloud
    service: all
  tasks:
    - name: Ensure deploy directory exists
      ansible.builtin.file:
        path: "{{ deploy_path }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: yes

    - name: Sync application files to server
      ansible.builtin.synchronize:
        src: "{{ src }}/"
        dest: "{{ deploy_path }}"
        recursive: yes
        delete: yes

    - name: Generate templated env files
      ansible.builtin.template:
        src: "{{ src }}/{{ item.src }}"
        dest: "{{ deploy_path }}/{{ item.dest }}"
        mode: "0600"
      vars:
        secrets: "{{ hostvars['localhost'][item.secrets_var] }}"
      loop:
        - { src: ".env.j2", dest: ".env", secrets_var: "secrets" }
        - { src: "Services/WebApp/deployment/.env.j2", dest: "Services/WebApp/deployment/.env", secrets_var: "Services_WebApp_deployment_dotenv" }
      no_log: true

    - name: Write secret files
      ansible.builtin.copy:
        content: "{{ hostvars['localhost'][item.content_var] }}"
        dest: "{{ deploy_path }}/{{ item.dest }}"
        mode: "0600"
      loop:
        - { dest: "lb/certs/mycrocloud.info.key", content_var: "lb_certs_mycrocloud_info_key" }
        - { dest: "Services/WebApp/WebApp.Api/gha-mycrocloud.pem", content_var: "Services_WebApp_WebApp_Api_gha_mycrocloud_pem" }
      no_log: true

    - name: Copy Web/.env.example to Web/.env
      ansible.builtin.copy:
        src: "{{ deploy_path }}/Web/.env.example"
        dest: "{{ deploy_path }}/Web/.env"
        remote_src: true

    - name: Pull and deploy services
      community.docker.docker_compose_v2:
        project_src: "{{ deploy_path }}"
        services: "{{ omit if service == 'all' else [service] }}"
        state: present
        pull: always

    - name: Reload nginx if dependencies require it
      ansible.builtin.command:
        cmd: docker compose exec lb nginx -s reload
        chdir: "{{ deploy_path }}"
      when: service in ['api', 'apigateway', 'web', 'web-editor']
