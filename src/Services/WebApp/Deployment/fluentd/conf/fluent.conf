<source>
  @type unix
  path /var/run/fluentd/fluentd.sock
</source>

<filter app.builder app.worker>
  @type record_transformer
  enable_ruby true
  <record>
    tag ${tag}
    @timestamp ${time.strftime('%Y-%m-%dT%H:%M:%S%z')}
  </record>
</filter>

<match app.builder app.worker>
  @type copy

  <store>
    @type elasticsearch
    host <host>
    port 443
    scheme https
    user <user>
    password <password>
    ssl_verify true
    verify_es_version_at_startup false
    default_elasticsearch_version 7
    logstash_format true
  </store>
  <store>
    @type rabbitmq
    amqp_url amqp://guest:guest@rabbitmq:5672/%2F
    exchange app.build.logs
    exchange_type topic
    routing_key app_build_logs.${record["build_id"]}
  </store>
  <store>
    @type stdout
  </store>
</match>