<source>
  @type unix
  path /var/run/fluent/fluent.sock
</source>

<filter app.builder>
  @type record_transformer
  enable_ruby true
  <record>
    @timestamp ${time.strftime('%Y-%m-%dT%H:%M:%S%z')}
    build_id ${record.dig("container_labels","build_id") || "unknown"}
    source builder
    message ${record["log"]}
  </record>
  remove_keys log,container_id,container_name,container_labels,source
</filter>

<match app.builder>
  @type copy

  <store>
    @type elasticsearch
    host <host>
    port 443
    scheme https
    user <user>
    password <password>
    ssl_verify true
    verify_es_version_at_startup false
    default_elasticsearch_version 7
    logstash_format true
  </store>
  <store>
    @type rabbitmq
    host rabbitmq
    exchange app.build.logs
    exchange_type topic
    routing_key app.build.logs.${record["container_labels"]["build_id"]}
  </store>
  <store>
    @type stdout
  </store>
</match>