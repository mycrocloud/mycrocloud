@using MockServer.Web.Controllers
@model MockServer.Web.Models.WebApplications.Routes.RouteIndexModel
@{
    ViewData["Title"] = Model.WebApplication.Name;
}
@(await Html.RenderComponentAsync<MockServer.Web.Views.Shared.Component.Component>(RenderMode.ServerPrerendered,new
        { Model = Model}))
<!-- New request: Start -->
<script>
    $(function () {
        $('.js-new-request-button').click(function () {
            $.get({
                url: '@Url.Action(nameof(WebApplicationRoutesController.GetCreatePartial), "ProjectRequests", new {ProjectName = Model.WebApplication.Name})',
                success: function (data) {
                    const html = data;
                    const partial = $('#ajax-partial').html(html);
                    const modal = $('.modal', partial);
                    initSaveRequestModal(modal);
                    $('#btnSave', modal).click(function () {
                        let request = {
                            Type: $('input[name=Type]:checked', modal).val(),
                            Name: $('input[name=Name]', modal).val(),
                            Description: $('input[name=Description]', modal).val(),
                            Method: $('select[name=Method] option:selected', modal).val(),
                            Path: $('input[name=Path]', modal).val()
                        };
                        $.post({
                            url: '@Url.Action(nameof(WebApplicationRoutesController.CreateAjax), "Requests", new {projectName = ViewData["ProjectName"]})',
                            data: request,
                            success: function (data) {
                                $('#btnSave', modal).off('click');
                                const id = data;
                                modal.data('id', id);
                                modal.modal('hide');
                            },
                            error: function () {
                                alert('something went wrong');
                            }
                        });
                    });
                    modal.on('hidden.bs.modal', function (e) {
                        if (modal.data('id') !== undefined) {
                            location.reload();
                        }
                        modal.remove();
                    });
                    modal.modal('show');
                }
            });
        });
    });
</script>
<!-- New request: End -->
<!-- Conext menu: Start -->
<script>
    $(function () {
        $('#requests .btn-context-menu').click(showRequestContextMenu);
    });

    function showRequestContextMenu() {
        $('.btn-clicked').removeClass('btn-clicked');
        $(document).off('click', documentClickHandler);
        $('.context-menu button').off('click');
        $('.context-menu').remove();

        const requestId = $(this).closest('li').data('request-id');
        $(this).addClass('btn-clicked');
        var position = $(this).offset();
        const container = $($('#context-menu-template').html());
        var left = (position.left - 70 + $(this).outerWidth()) + 'px';
        var top = (position.top + $(this).outerHeight()) + 'px';
        container.css({'left': left, 'top': top});
        $('.btn-group-vertical button', container).click(function () {
            $('.btn-clicked').removeClass('btn-clicked');
            $(document).off('click', documentClickHandler);
            $('.context-menu button').off('click');
            $('.context-menu').remove();
        });
        const deleteButton = $('button[name=btnDelete]', container);
        deleteButton.click(function () {
            //show confirm modal
            const modal = $($('#requestDeleteConfirmModalTemplate').html());
            $('body').append(modal);

            $("#requestDeleteConfirmModal button[name=btnDelete]").click(function () {
                $(this).off('click');
                deleteRequest(requestId);
                $("#requestDeleteConfirmModal").modal("hide");
            });

            $("#requestDeleteConfirmModal").on('hide.bs.modal', function () {
                $("#requestDeleteConfirmModal button[name=btnDelete]").off('click');
                $("#requestDeleteConfirmModal").remove();
            })
            $("#requestDeleteConfirmModal").modal("show");
            $(this).off('click');
        });
        $('.request-container').append(container);
        $(document).click(documentClickHandler);
    }
    const documentClickHandler = function (e) {
        const menu = $('.context-menu');
        const button = $('.btn-clicked');
        // Check if the target of the click event is the context menu or one of its children
        if (e.target !== menu[0] && !menu.has(e.target).length && !$(e.target).is(button)) {
            button.removeClass('btn-clicked');
            // Remove the event handler
            $(document).off('click', documentClickHandler);
            //Remove the menu
            menu.remove();
        }
    }

    function deleteRequest(id) {
        const tempUrl = '@Url.Action(nameof(WebApplicationRoutesController.Delete), "ProjectRequests", new { RequestId = Constants.TemporaryId})'
        $.post({
            async: false,
            url: tempUrl.replace(@Constants.TemporaryId, id),
            success: function () {
                $('#requests [data-request-id=' + id + ']').remove();
            }
        });
    }
</script>
<!-- Conext menu: End -->
<!-- Open request: Start -->
<script>
    $(function () {
        const tempUrl = '@Url.Action(nameof(WebApplicationRoutesController.View), "ProjectRequests", new {ProjectName = @Model.WebApplication.Name, RequestId = Constants.TemporaryId})';
        $('.js-open-request').click(function () {
            const selected = $(this).closest('li');
            selected.parent().find('li').removeClass('bg-gray');
            selected.addClass('bg-gray');
            const id = selected.data('request-id');
            $('#RequestOpenContent').load(tempUrl.replace(@Constants.TemporaryId, id));
        });
    });
</script>
<!-- Open request: End -->