@using MockServer.Web.Controllers
@using MockServer.Core.WebApplications.Security
@using MockServer.Core.WebApplications
@model MockServer.Web.Models.WebApplications.Routes.RouteIndexViewModel
@{
    var httpMethods = Model.HttpMethodSelectListItem.Select(m => new
    {
        Title = m.Text.ToUpper(),
        Value = m.Value.ToUpper()
    }
    )
    .Prepend(new
    {
        Title = "ANY",
        Value = "*"
    });
    var authorizationAuthenticationSchemes = Model.AuthorizationAuthenticationSchemeSelectListItem
    .Select(p => new
    {
        Value = int.Parse(p.Value),
        Title = p.Text
    });
    var policies = Model.AuthorizationPolicySelectListItem
    .Select(p => new
    {
        Value = int.Parse(p.Value),
        Title = p.Text
    });
    var responseProviders = Html.GetEnumSelectList<ResponseProvider>()
    .Select(p => new
    {
        Value = ((ResponseProvider)int.Parse(p.Value)).ToString(),
        Title = p.Text.ToUpper()
    });
}
<partial name="/Views/WebApplications/Routes/_Partial/_ValidationRulesConfigComponent.cshtml" />
<template id="routeEditorTemplate">
    <v-form v-on:submit.prevent="onSubmit">
        <v-card>
            <v-card-text>
                <section>
                    <h5>BASIC INFORMATION</h5>
                    <v-text-field v-model="route.name" clearable label="Name" variant="solo"></v-text-field>
                    <v-textarea v-model="route.description" clearable label="Description" variant="solo"
                        rows="2"></v-textarea>
                </section>
                <v-divider></v-divider>
                <section>
                    <h5>MATCH</h5>
                    <v-select v-model="route.match.methods" :items="httpMethods" item-title="title" item-value="value"
                        label="METHOD(S)" clearable chips multiple variant="solo">
                    </v-select>
                    <v-text-field v-model="route.match.path" label="PATH" variant="solo" clearable></v-text-field>
                    <v-row no-gutters>
                        <v-col cols="3">
                            <v-text-field v-model="route.match.order" label="ORDER" type="number"
                                variant="solo"></v-text-field>
                        </v-col>
                    </v-row>
                </section>
                <v-divider></v-divider>
                <section>
                    <h5>AUTHORIZATION</h5>
                    <div>
                        <v-radio-group v-model="route.authorization.type" inline label="TYPE">
                            <v-radio label="ALLOW ANONYMOUS" :value="'@nameof(AuthorizationType.AllowAnonymous)'">
                            </v-radio>
                            <v-radio label="AUTHORIZED" :value="'@nameof(AuthorizationType.Authorized)'">
                            </v-radio>
                        </v-radio-group>
                        <v-expand-transition>
                            <div v-show="route.authorization.type == '@nameof(AuthorizationType.Authorized)'">
                                <v-select v-model="route.authorization.authenticationSchemeIds"
                                    label="AUTHENTICATION SCHEMES" :items="authorizationAuthenticationSchemes" multiple
                                    variant="solo">
                                </v-select>
                                <v-select v-model="route.authorization.policyIds" clearable label="POLICIES"
                                    :items="policies" multiple variant="solo">
                                </v-select>
                            </div>
                        </v-expand-transition>
                    </div>
                </section>
                <v-divider></v-divider>
                <section>
                    <h5>VALIDATION</h5>
                    <v-card>
                        <v-tabs v-model="requestValidationTab">
                            <v-tab value="queryParams">QUERY PARAMETERS</v-tab>
                            <v-tab value="headers">HEADERS</v-tab>
                            <v-tab value="body">BODY</v-tab>
                        </v-tabs>
                        <v-card-text>
                            <v-window v-model="requestValidationTab">
                                <v-window-item class="p-2" value="queryParams">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th style="width: 20%" scope="col">PARAMETER</th>
                                                <th style="width: 75%" scope="col">RULES</th>
                                                <th style="width: 5%" scope="col">ACTIONS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(param, index) in route.validation.queryParameters">
                                                <td>
                                                    <v-text-field v-model="param.name" placeholder="name"
                                                        variant="solo">
                                                    </v-text-field>
                                                </td>
                                                <td>
                                                    <div class="d-flex flex-row pa-2 mb-6">
                                                        <template v-if="param.rules.length === 0">
                                                            <span class="pa-2 ma-2">No rules configured yet.</span>
                                                        </template>
                                                        <template v-else>
                                                            <v-chip-group>
                                                                <v-chip
                                                                    v-for="(rule, index) of param.rules.slice(0, 3)">
                                                                    {{rule.name}}
                                                                </v-chip>
                                                                <v-chip v-if="param.rules.length > 3">
                                                                    (+{{param.rules.length - 3 }} others)
                                                                </v-chip>
                                                            </v-chip-group>
                                                        </template>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex flex-row mb-6">
                                                        <v-btn icon="mdi-cog" class="ma-2 pa-2"
                                                            v-on:click="showValidationRulesConfigDialog('queryParams', index, param.rules)">
                                                        </v-btn>
                                                        <v-btn icon="mdi-delete" class="ma-2 pa-2"
                                                            v-on:click="route.validation.queryParameters.splice(index)">
                                                        </v-btn>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div>
                                        <v-btn prepend-icon="mdi-plus" class="bg-secondary"
                                            v-on:click="addValidationRow('queryParams')">ADD</v-btn>
                                    </div>
                                </v-window-item>
                                <v-window-item class="p-2" value="headers">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th style="width: 20%" scope="col">HEADER</th>
                                                <th style="width: 75%" scope="col">RULES</th>
                                                <th style="width: 5%" scope="col">ACTIONS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(header, index) in route.validation.headers">
                                                <td>
                                                    <v-text-field v-model="header.name" placeholder="name"
                                                        variant="solo">
                                                    </v-text-field>
                                                </td>
                                                <td>
                                                    <div class="d-flex flex-row pa-2 mb-6">
                                                        <template v-if="header.rules.length === 0">
                                                            <span class="pa-2 ma-2">
                                                                No rules configured yet.
                                                            </span>
                                                        </template>
                                                        <template v-else>
                                                            <v-chip-group>
                                                                <v-chip
                                                                    v-for="(rule, index) of header.rules.slice(0, 3)">
                                                                    {{rule.name}}
                                                                </v-chip>
                                                                <v-chip v-if="header.rules.length > 3">
                                                                    (+{{header.rules.length - 3 }} others)
                                                                </v-chip>
                                                            </v-chip-group>
                                                        </template>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex flex-row mb-6">
                                                        <v-btn icon="mdi-cog" class="ma-2 pa-2"
                                                            v-on:click="showValidationRulesConfigDialog('headers', index, header.rules)">
                                                        </v-btn>
                                                        <v-btn icon="mdi-delete" class="ma-2 pa-2"
                                                            v-on:click="route.validation.headers.splice(index)">
                                                        </v-btn>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div>
                                        <v-btn prepend-icon="mdi-plus" color="secondary"
                                            v-on:click="addValidationRow('headers')">ADD</v-btn>
                                    </div>
                                </v-window-item>
                                <v-window-item class="p-2" value="body">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th style="width: 20%" scope="col">FIELD</th>
                                                <th style="width: 75%" scope="col">RULES</th>
                                                <th style="width: 5%" scope="col">ACTIONS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(field, index) in route.validation.body">
                                                <td>
                                                    <v-text-field v-model="field.field" placeholder="field"
                                                        variant="solo">
                                                    </v-text-field>
                                                </td>
                                                <td>
                                                    <div class="d-flex flex-row pa-2 mb-6">
                                                        <template v-if="field.rules.length === 0">
                                                            <span class="pa-2 ma-2">
                                                                No rules configured yet.
                                                            </span>
                                                        </template>
                                                        <template v-else>
                                                            <v-chip-group>
                                                                <v-chip
                                                                    v-for="(rule, index) of field.rules.slice(0, 3)">
                                                                    {{rule.name}}
                                                                </v-chip>
                                                                <v-chip v-if="field.rules.length > 3">
                                                                    (+{{field.rules.length - 3 }} others)
                                                                </v-chip>
                                                            </v-chip-group>
                                                        </template>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex flex-row mb-6">
                                                        <v-btn icon="mdi-cog" class="ma-2 pa-2"
                                                            v-on:click="showValidationRulesConfigDialog('body', index, field.rules)">
                                                        </v-btn>
                                                        <v-btn icon="mdi-delete" class="ma-2 pa-2"
                                                            v-on:click="route.validation.body.splice(index, 1)">
                                                        </v-btn>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div>
                                        <v-btn prepend-icon="mdi-plus" color="secondary"
                                            v-on:click="addValidationRow('body')">ADD</v-btn>
                                    </div>
                                </v-window-item>
                            </v-window>
                        </v-card-text>
                    </v-card>
                    <validation-rules-config-dialog v-if="validationRules" :rules="validationRules"
                        @@save="saveValidationRules" @@close="closeValidationRulesConfigDialog">
                    </validation-rules-config-dialog>
                </section>
                <v-divider></v-divider>
                <section>
                    <h5>RESPONSE</h5>
                    <v-select v-model="route.response.provider" label="PROVIDER" :items="responseProviders"
                        variant="solo">
                    </v-select>
                    <div v-show="route.response.provider=='@nameof(ResponseProvider.Mock)'">
                        <div class="text-subtitle-2">STATUS CODE</div>
                        <v-row>
                            <v-col cols="3">
                                <v-select v-model="route.response.mock.statusCode.renderedValue.engine" label="TYPE"
                                    :items="[{value: 'None', title: 'STATIC'}, {value: 'JavaScript', title: 'EVALUATED'}]"
                                    variant="solo">
                                </v-select>
                            </v-col>
                            <v-col>
                                <v-text-field v-model="route.response.mock.statusCode.renderedValue.template"
                                    :type="route.response.mock.statusCode.renderedValue.engine == 'None'? 'number': 'text'"
                                    :label="route.response.mock.statusCode.renderedValue.engine == 'None'? 'VALUE': 'EXPRESSION'"
                                    variant="solo"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-container class="px-0">
                            <div class="text-subtitle-2">HEADERS</div>
                            <v-row v-for="(header, index) of route.response.mock.headers" class="py-0">
                                <v-col cols="3">
                                    <v-text-field label="NAME" v-model="header.name" variant="solo"></v-text-field>
                                </v-col>
                                <v-col cols="3">
                                    <v-select v-model="header.value.renderedValue.engine" label="VALUE TYPE"
                                        :items="[{value: 'None', title: 'STATIC'}, {value: 'JavaScript', title: 'EVALUATED'}]"
                                        variant="solo">
                                    </v-select>
                                </v-col>
                                <v-col>
                                    <v-text-field v-model="header.value.renderedValue.template"
                                        :label="header.value.renderedValue.engine === 'None' ? 'VALUE': 'EXPRESSION'"
                                        variant="solo"></v-text-field>
                                </v-col>
                                <v-col cols="1">
                                    <v-btn icon="mdi-delete" color="danger"
                                        v-on:click="route.response.mock.headers.splice(index)"></v-btn>
                                </v-col>
                            </v-row>
                            <v-btn prepend-icon="mdi-plus" color="secondary"
                                v-on:click="route.response.mock.headers.push({value: {renderedValue: { engine: 'None'}}})">ADD</v-btn>
                        </v-container>
                        <v-container class="px-0">
                            <div class="text-subtitle-2">BODY</div>
                            <v-select class="col-3" v-model="route.response.mock.body.renderedValue.engine" label="TYPE" :items="[{value: 'None', title: 'STATIC'}, {value: 'JavaScript', title: 'EVALUATED'},
                                            {value: 'Handlebars', title: 'Handlebars'}]" variant="solo">
                            </v-select>
                            <div class="d-flex">
                                <v-select class="col-3" v-model="route.response.mock.body.renderedValue.format"
                                    :items="['json', 'plain text', 'javascript']" label="FORMAT" variant="solo">
                                </v-select>
                                <v-spacer></v-spacer>
                                <v-btn>BEAUTIFY</v-btn>
                            </div>
                            <div>
                                <div>{{route.response.mock.body.renderedValue.engine === 'None'? 'VALUE':
                                    route.response.mock.body.renderedValue.engine === 'JavaScript'? 'EXPRESSION':
                                    'TEMPLATE'}}</div>
                                <div id="bodyEditor" class="w-100 rounded-0"
                                    style="height: 300px; border: 1px solid grey;">
                                </div>
                            </div>
                        </v-container>
                    </div>
                    <div v-show="route.response.provider=='@nameof(ResponseProvider.ProxiedServer)'">
                        <v-container>Proxied Server</v-container>
                    </div>
                    <div v-show="route.response.provider=='@nameof(ResponseProvider.Function)'">
                        <v-container>Function</v-container>
                    </div>
                </section>
            </v-card-text>
            <v-card-actions>
                <v-btn @@click="cancel">CANCEL</v-btn>
                <v-btn type="submit" variant="elevated" color="primary">SAVE</v-btn>
            </v-card-actions>
        </v-card>
    </v-form>
</template>
<script>
    const RouteEditorComponent = {
        template: '#routeEditorTemplate',
        components: {
            'validation-rules-config-dialog': ValidationRulesConfigComponent
        },
        props: {
            route: {
                type: Object,
                required: true
            }
        },
        setup(props) {
            const { route } = props
            //
            const httpMethods = JSON.parse('@Json.Serialize(httpMethods)');
            //

            //
            const authorizationAuthenticationSchemes = JSON.parse('@Json.Serialize(authorizationAuthenticationSchemes)');
            const policies = JSON.parse('@Json.Serialize(policies)');
            const deleteAuthorizationClaim = (index) => {
                route.authorization.claims.splice(index, 1)
            }
            const addAuthorizationClaim = () => {
                route.authorization.claims = route.authorization.claims || [];
                route.authorization.claims.push({ type: '', allowedValues: '' })
            }
            //
            // Request Validation: START
            const requestValidationTab = ref();
            const addValidationRow = (prop) => {
                let emptyRule = { name: null, rules: [] };
                if (prop === 'queryParams') {
                    route.validation.queryParameters ??= [];
                    route.validation.queryParameters.push(emptyRule);
                } else if (prop === 'headers') {
                    route.validation.headers ??= [];
                    route.validation.headers.push(emptyRule);
                } else if (prop === 'body') {
                    route.validation.body ??= [];
                    route.validation.body.push(emptyRule);
                }
            }
            const validationRules = ref(null)
            let validationRulesFor = null;
            let validationRulesForIndex = null;
            const showValidationRulesConfigDialog = (prop, index, rules) => {
                validationRulesFor = prop;
                validationRulesForIndex = index;
                validationRules.value = [...rules];
            }
            const closeValidationRulesConfigDialog = () => {
                validationRules.value = null
                validationRulesFor = null
                validationRulesForIndex = null
            }
            const saveValidationRules = (rules) => {
                if (validationRulesFor === 'queryParams') {
                    route.validation.queryParameters[validationRulesForIndex].rules = rules;
                } else if (validationRulesFor === 'headers') {
                    route.validation.headers[validationRulesForIndex].rules = rules;
                } else if (validationRulesFor === 'body') {
                    route.validation.body[validationRulesForIndex].rules = rules;
                }
                validationRules.value = null
                validationRulesFor = null
                validationRulesForIndex = null
            }
            // Request Validation: END

            //
            const responseProviders = JSON.parse('@Json.Serialize(responseProviders)');
            //
            //Mock Response: START
            let bodyEditor;
            const mockResponseStatusCodeValueType = ref('number');
            //add watcher for route.response.mock.body.textFormat
            watch(() => route.response.mock.body.renderedValue.format, (newValue, oldValue) => {
                if (bodyEditor) {
                    monaco.editor.setModelLanguage(bodyEditor.getModel(), newValue)
                }
            });
            //Mock Response: END
            //
            const onSubmit = async () => {
                if(route.response.provider === 'Mock') {
                    route.response.mock.body.renderedValue.template = bodyEditor.getValue();
                }
                if (!await validate()) {
                    return;
                }
                let url;
                const isCreate = route.id === undefined || route.id === null;
                if (isCreate) {
                    url = '@Url.Action(nameof(WebApplicationRoutesController.Create), "WebApplicationRoutes", new { WebApplicationName = Model.WebApplication.Name})'
                } else {
                    let tempUrl = '@Url.Action(nameof(WebApplicationRoutesController.Edit), "WebApplicationRoutes", new { WebApplicationName = Model.WebApplication.Name, RouteId = -9999})'
                    url = tempUrl.replace('-9999', route.id);
                }
                console.log(JSON.stringify(route))
                const res = await axios.post(url, route)
                if (isCreate) {
                    //route.id = res.data.rou
                }
            }
            async function validate() {
                return true;
            }
            //

            //
            onMounted(() => {
                // Initialize the Monaco editor
                require.config({ paths: { vs: "lib/monaco-editor/min/vs" } });
                require(["vs/editor/editor.main"], function () {
                    bodyEditor = monaco.editor.create(document.getElementById("bodyEditor"), {
                        value: route.response.mock.body.renderedValue.template,
                        language: route.response.mock.body.renderedValue.format,
                        automaticLayout: true,
                    });
                });
            });
            return {
                httpMethods,
                authorizationAuthenticationSchemes,
                policies,
                addAuthorizationClaim,
                deleteAuthorizationClaim,
                requestValidationTab,
                addValidationRow,
                validationRules,
                showValidationRulesConfigDialog,
                closeValidationRulesConfigDialog,
                saveValidationRules,
                responseProviders,
                mockResponseStatusCodeValueType,
                onSubmit
            }
        }
    }
</script>